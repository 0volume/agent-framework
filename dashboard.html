<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Framework Dashboard</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1730;
      --card:#121c38;
      --card2:#101a34;
      --hover:#182552;
      --border:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.42);
      --accent:#58a6ff;
      --good:#3fb950;
      --warn:#f0883e;
      --bad:#f85149;
      --sol:#a371f7;
      --search:#58a6ff;
      --verify:#d29922;
      --summ:#3fb950;
      --sec:#f85149;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 16px;
      --radius-sm: 12px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0; padding:18px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(163,113,247,.12), transparent 60%),
                  radial-gradient(1000px 700px at 90% 10%, rgba(88,166,255,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:14px 16px; margin-bottom:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand h1{ margin:0; font-size:1.05rem; letter-spacing:.2px; }
    .brand .sub{ font-size:.75rem; color:var(--muted); }

    .right{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      font-size:.78rem; color:var(--muted);
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--good); animation:pulse 1.6s infinite; }
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px;
    }
    .tab{
      cursor:pointer; user-select:none;
      padding:8px 12px; border-radius: 999px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      color:var(--muted);
      font-size:.78rem;
      transition: all .15s ease;
    }
    .tab:hover{ background: rgba(255,255,255,.06); color:var(--text); }
    .tab.active{ background: rgba(88,166,255,.14); border-color: rgba(88,166,255,.35); color:var(--text); }

    .panel{ display:none; }
    .panel.active{ display:block; }

    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.25fr .75fr;
      align-items:start;
    }
    @media (max-width: 1100px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .title{
      display:flex; align-items:center; gap:10px;
      font-weight:750; font-size:.86rem; letter-spacing:.2px;
    }
    .meta{ font-size:.72rem; color:var(--muted); }

    .metrics{
      display:grid; gap:10px;
      grid-template-columns: repeat(4, minmax(0,1fr));
      padding:12px 14px;
    }
    @media (max-width: 900px){ .metrics{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .metric{
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: 14px;
      padding:10px 12px;
    }
    .metric .k{ font-size:.62rem; text-transform:uppercase; letter-spacing:.1em; color:var(--muted2); }
    .metric .v{ margin-top:4px; font-size:1rem; font-weight:750; }

    /* Sol feed */
    .feed{ padding:12px 14px; max-height: 420px; overflow:auto; }
    .evt{
      display:grid; grid-template-columns: 70px 86px 1fr;
      gap:10px; align-items:start;
      padding:10px 10px;
      margin-bottom:10px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.12);
      cursor:pointer;
      transition: background .15s ease;
    }
    .evt:hover{ background: rgba(255,255,255,.04); }
    .ts{ font-family:var(--mono); font-size:.68rem; color:var(--muted); }
    .tag{
      justify-self:start;
      font-size:.62rem; text-transform:uppercase; letter-spacing:.08em;
      padding:3px 8px; border-radius: 999px;
      border:1px solid var(--border);
      color:var(--muted);
      background: rgba(255,255,255,.02);
      white-space:nowrap;
    }
    .tag.message{ border-color: rgba(121,192,255,.35); color:#a8d1ff; }
    .tag.activity{ border-color: rgba(88,166,255,.35); color:#9fceff; }
    .tag.thinking{ border-color: rgba(163,113,247,.35); color:#d4b8ff; }
    .tag.reasoning{ border-color: rgba(240,136,62,.45); color:#ffd1a7; }
    .tag.decision{ border-color: rgba(255,123,114,.35); color:#ffb4ad; }
    .tag.memory{ border-color: rgba(247,120,186,.35); color:#ffc2e7; }
    .tag.improvement{ border-color: rgba(110,231,183,.35); color:#bfffea; }
    .tag.result{ border-color: rgba(63,185,80,.35); color:#bff5c9; }

    .summary{ font-size:.86rem; line-height:1.35; color:var(--text); }
    .subline{ margin-top:6px; color:var(--muted); font-size:.76rem; }

    /* Agent tiles */
    .tiles{ padding:12px 14px; display:grid; gap:12px; grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (max-width: 1100px){ .tiles{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 650px){ .tiles{ grid-template-columns: 1fr; } }

    .tile{
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition: transform .15s ease, background .15s ease;
    }
    .tile:hover{ transform: translateY(-1px); background: rgba(255,255,255,.05); }
    .tile .th{
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:750; font-size:.78rem;
    }
    .leftlab{ display:flex; align-items:center; gap:8px; }
    .st{ font-size:.62rem; color:var(--muted); border:1px solid var(--border); border-radius:999px; padding:2px 8px; background: rgba(0,0,0,.15); }
    .st.active{ color:var(--good); border-color: rgba(63,185,80,.35); background: rgba(63,185,80,.08); }
    .tile .tb{ max-height: 170px; overflow:auto; border-top:1px solid var(--border); }
    .mini{ display:flex; gap:10px; padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.05); font-size:.74rem; color:var(--muted); }
    .mini:last-child{ border-bottom:none; }
    .mini .mT{ min-width:50px; font-family:var(--mono); font-size:.66rem; color:var(--muted2); }
    .mini .mS{ flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* System live cards + graphs */
    .sysGrid{ display:grid; gap:12px; grid-template-columns: repeat(3, minmax(0,1fr)); padding:12px 14px; }
    @media (max-width: 900px){ .sysGrid{ grid-template-columns: 1fr; } }
    .sysCard{ cursor:pointer; }
    canvas{ display:block; width:100%; height:76px; margin-top:8px; }

    /* Modal */
    #modal{ display:none; position:fixed; inset:0; z-index:9999; background: rgba(0,0,0,.78); padding:24px; }
    .modalBox{
      max-width: 980px; margin:0 auto;
      background: rgba(10,16,32,.96);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHd{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid var(--border); }
    .modalHd .ttl{ font-weight:800; font-size:.9rem; }
    .btn{ background: transparent; color:var(--text); border:1px solid var(--border); border-radius: 12px; padding:6px 10px; cursor:pointer; }
    .modalBody{ padding:14px; max-height: 70vh; overflow:auto; }
    pre{ margin:0; white-space:pre-wrap; word-break:break-word; font-size:.84rem; line-height:1.4; }

    .footer{ margin-top:14px; text-align:center; color:var(--muted2); font-size:.72rem; }
    code{ font-family:var(--mono); font-size:.78em; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <h1>Agent Framework</h1>
      <div class="sub">Read‚Äëonly monitoring ‚Ä¢ drill‚Äëdown everywhere ‚Ä¢ stable via systemd</div>
    </div>
    <div class="right">
      <div class="pill"><span class="dot"></span><span>LIVE</span></div>
      <div class="pill">Last refresh: <span id="fetchTs">--</span></div>
      <div class="pill"><span id="jsStatus">JS: loading‚Ä¶</span></div>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="overview">Overview</div>
    <div class="tab" data-tab="history">History</div>
    <div class="tab" data-tab="thoughts">Thoughts</div>
    <div class="tab" data-tab="memories">Memories</div>
    <div class="tab" data-tab="improvements">Improvements</div>
    <div class="tab" data-tab="system">System</div>
  </div>

  <!-- OVERVIEW -->
  <section class="panel active" id="panel-overview">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div class="title">üß† Sol ‚Ä¢ Live cognitive feed</div>
          <div class="meta"><span id="solCount">0</span> events ‚Ä¢ last: <span id="solLast">--</span></div>
        </div>
        <div class="metrics">
          <div class="metric"><div class="k">Tavily remaining/hr</div><div class="v" id="mTavily">--/5</div></div>
          <div class="metric"><div class="k">LLM remaining/hr</div><div class="v" id="mLlm">--/20</div></div>
          <div class="metric"><div class="k">DB events shown</div><div class="v" id="mEvents">--</div></div>
          <div class="metric"><div class="k">System load</div><div class="v" id="ovLoad">--</div></div>
          <div class="metric"><div class="k">Mem avail</div><div class="v" id="ovMem">--</div></div>
          <div class="metric"><div class="k">Disk free</div><div class="v" id="ovDisk">--</div></div>
          <div class="metric"><div class="k">Dashboard</div><div class="v">Read‚Äëonly</div></div>
          <div class="metric"><div class="k">Live graphs</div><div class="v" style="font-size:.85rem;">See below</div></div>
        </div>

        <div class="sysGrid" style="padding-top:0;">
          <div class="metric sysCard" data-drill="sys"><div class="k">CPU load (1m)</div><div class="v" id="sysLoadOv">--</div><canvas id="chartLoadOv" width="420" height="76"></canvas></div>
          <div class="metric sysCard" data-drill="sys"><div class="k">Memory available</div><div class="v" id="sysMemAvailOv">--</div><canvas id="chartMemOv" width="420" height="76"></canvas></div>
          <div class="metric sysCard" data-drill="sys"><div class="k">Disk free (/)</div><div class="v" id="sysDiskFreeOv">--</div><canvas id="chartDiskOv" width="420" height="76"></canvas></div>
        </div>
        <div class="feed" id="solFeed">
          <div class="meta" style="padding:10px 2px;">Click any item to expand.</div>
          <div id="solFeedInner"></div>
          <div class="meta" id="solEmpty" style="display:none;">No events yet.</div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div class="title">ü§ù Agents</div>
          <div class="meta">Click a tile ‚Üí History</div>
        </div>
        <div class="tiles" id="agentTiles"></div>
      </div>
    </div>
  </section>

  <!-- HISTORY -->
  <section class="panel" id="panel-history">
    <div class="card">
      <div class="hd">
        <div class="title">üìú History</div>
        <div class="meta">DB-backed ‚Ä¢ summary row + click for detail</div>
      </div>
      <div style="padding:12px 14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <select id="hAgent" style="background:var(--card2);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:8px 10px;font-size:.82rem;"></select>
        <select id="hType" style="background:var(--card2);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:8px 10px;font-size:.82rem;"></select>
        <input id="hSearch" placeholder="Search‚Ä¶" style="flex:1;min-width:220px;background:var(--card2);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:8px 10px;font-size:.82rem;" />
        <select id="hLimit" style="background:var(--card2);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:8px 10px;font-size:.82rem;"><option>100</option><option>250</option><option>500</option></select>
      </div>
      <div style="overflow:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:rgba(255,255,255,.02);">
              <th style="text-align:left;padding:10px 12px;font-size:.65rem;color:var(--muted2);text-transform:uppercase;letter-spacing:.1em;border-top:1px solid var(--border);border-bottom:1px solid var(--border);width:170px;">Time (UTC)</th>
              <th style="text-align:left;padding:10px 12px;font-size:.65rem;color:var(--muted2);text-transform:uppercase;letter-spacing:.1em;border-top:1px solid var(--border);border-bottom:1px solid var(--border);width:110px;">Agent</th>
              <th style="text-align:left;padding:10px 12px;font-size:.65rem;color:var(--muted2);text-transform:uppercase;letter-spacing:.1em;border-top:1px solid var(--border);border-bottom:1px solid var(--border);width:120px;">Type</th>
              <th style="text-align:left;padding:10px 12px;font-size:.65rem;color:var(--muted2);text-transform:uppercase;letter-spacing:.1em;border-top:1px solid var(--border);border-bottom:1px solid var(--border);">Summary</th>
            </tr>
          </thead>
          <tbody id="hBody"></tbody>
        </table>
      </div>
      <div class="footer" style="margin:10px 0 14px;">Tip: click any row to expand the human-readable detail.</div>
    </div>
  </section>

  <!-- THOUGHTS -->
  <section class="panel" id="panel-thoughts">
    <div class="card"><div class="hd"><div class="title">üí≠ Thoughts</div><div class="meta">Click to expand</div></div><div class="feed" id="thoughtList"></div></div>
  </section>

  <!-- MEMORIES -->
  <section class="panel" id="panel-memories">
    <div class="card"><div class="hd"><div class="title">üìù Memories</div><div class="meta">Click to expand</div></div><div class="feed" id="memoryList"></div></div>
  </section>

  <!-- IMPROVEMENTS -->
  <section class="panel" id="panel-improvements">
    <div class="card"><div class="hd"><div class="title">‚ú® Improvements</div><div class="meta">Click to expand</div></div><div class="feed" id="improveList"></div></div>
  </section>

  <!-- SYSTEM -->
  <section class="panel" id="panel-system">
    <div class="card">
      <div class="hd">
        <div class="title">üñ•Ô∏è System (live)</div>
        <div class="meta">Fetched from <code>/sys.json</code> every 2s ‚Ä¢ not stored</div>
      </div>
      <div class="sysGrid">
        <div class="metric sysCard" data-drill="sys"><div class="k">CPU load (1m/5m/15m)</div><div class="v" id="sysLoad">--</div><canvas id="chartLoad" width="420" height="76"></canvas></div>
        <div class="metric sysCard" data-drill="sys"><div class="k">Memory available</div><div class="v" id="sysMemAvail">--</div><canvas id="chartMem" width="420" height="76"></canvas></div>
        <div class="metric sysCard" data-drill="sys"><div class="k">Disk free (/)</div><div class="v" id="sysDiskFree">--</div><canvas id="chartDisk" width="420" height="76"></canvas></div>
      </div>
      <div class="footer" style="margin-top:0;">Click a card to open full system JSON.</div>
    </div>
  </section>

  <!-- Modal -->
  <div id="modal">
    <div class="modalBox">
      <div class="modalHd">
        <div class="ttl" id="modalTitle">Details</div>
        <button class="btn" id="modalClose">Close</button>
      </div>
      <div class="modalBody">
        <pre id="modalBody"></pre>
      </div>
    </div>
  </div>

  <div class="footer">Auto-refresh: 2s ‚Ä¢ Read-only ‚Ä¢ If UI looks stale, hard refresh (Ctrl+F5).</div>

  <script>
    const AGENTS = [
      {key:'search', name:'Search', icon:'üîç', color:'var(--search)'},
      {key:'verify', name:'Verify', icon:'‚úì', color:'var(--verify)'},
      {key:'summarize', name:'Summarize', icon:'üìù', color:'var(--summ)'},
      {key:'security', name:'Security', icon:'üîí', color:'var(--sec)'},
    ];

    const SYS_HIST = { load1:[], memAvailMb:[], diskFreeGb:[], max:120 };

    let DATA = null;
    let LAST_SYS = null;

    const qs = (s)=>document.querySelector(s);
    const qsa = (s)=>Array.from(document.querySelectorAll(s));

    function safe(s){
      if(s===null||s===undefined) return '';
      return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }

    function openModal(title, detailText){
      qs('#modalTitle').textContent = title;
      qs('#modalBody').textContent = detailText || '';
      qs('#modal').style.display='block';
    }
    function closeModal(){ qs('#modal').style.display='none'; }
    qs('#modalClose').addEventListener('click', closeModal);
    qs('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });

    function setTabs(){
      qsa('.tab').forEach(t=>{
        t.addEventListener('click', ()=>{
          qsa('.tab').forEach(x=>x.classList.remove('active'));
          qsa('.panel').forEach(x=>x.classList.remove('active'));
          t.classList.add('active');
          qs('#panel-'+t.dataset.tab).classList.add('active');
          if(t.dataset.tab==='history') renderHistory();
        });
      });
    }

    function fmtBytes(n){
      if(n===null||n===undefined) return '--';
      const u=['B','KB','MB','GB','TB'];
      let x=Number(n); let i=0;
      while(x>=1024 && i<u.length-1){ x/=1024; i++; }
      return (i>=2? x.toFixed(1): Math.round(x)) + ' ' + u[i];
    }

    function drawSpark(canvasId, values, color){
      const c = qs('#'+canvasId);
      if(!c) return;
      const ctx = c.getContext('2d');
      const w=c.width, h=c.height;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle='rgba(255,255,255,0.02)';
      ctx.fillRect(0,0,w,h);
      if(values.length<2) return;
      const min=Math.min(...values), max=Math.max(...values);
      const span=(max-min)||1;
      ctx.strokeStyle=color; ctx.lineWidth=2;
      ctx.beginPath();
      values.forEach((v,idx)=>{
        const x = idx*(w/(values.length-1));
        const y = h - ((v-min)/span)*(h-10) - 5;
        if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    function recentActive(entries){
      if(!entries.length) return false;
      const last = entries[entries.length-1];
      const ts = last.full_timestamp || '';
      const t = Date.parse(ts);
      if(Number.isNaN(t)) return false;
      return (Date.now() - t) < 2*60*1000;
    }

    function renderTiles(){
      const tiles = AGENTS.map(a=>{
        const entries = (DATA?.agents?.[a.key]||[]);
        const active = recentActive(entries);
        const st = active ? 'ACTIVE' : (entries.length ? 'IDLE (stale)' : 'IDLE');
        const stCls = active ? 'st active' : 'st';
        const minis = entries.slice(-6).map(e=>{
          const txt = (e.content || e.details || '').toString().replace(/\n/g,' ');
          return `<div class="mini"><div class="mT">${safe(e.timestamp||'')}</div><div class="mS">${safe(txt).slice(0,120)}</div></div>`;
        }).join('') || `<div class="mini"><div class="mS">Idle</div></div>`;
        return `
          <div class="tile" data-agent="${a.key}">
            <div class="th" style="border-left:4px solid ${a.color}">
              <div class="leftlab">${a.icon} ${a.name}</div>
              <div class="${stCls}">${st}</div>
            </div>
            <div class="tb">${minis}</div>
          </div>
        `;
      }).join('');
      qs('#agentTiles').innerHTML = tiles;

      qsa('.tile').forEach(el=>{
        el.addEventListener('click', ()=>{
          // Switch to history filtered
          qs('[data-tab="history"]').click();
          qs('#hAgent').value = el.dataset.agent;
          renderHistory();
        });
      });
    }

    function evtRow(e){
      const ts = (e.timestamp || '').toString();
      const tag = (e.type || 'status').toString();
      const summary = (e.content || e.summary || '').toString();
      const detail = (e.details || e.detail_text || '').toString();
      return `
        <div class="evt" data-detail="${safe(detail||summary)}" data-title="${safe(tag)}">
          <div class="ts">${safe(ts)}</div>
          <div class="tag ${safe(tag)}">${safe(tag)}</div>
          <div>
            <div class="summary">${safe(summary)}</div>
            ${detail ? `<div class="subline">Click for detail</div>` : ``}
          </div>
        </div>
      `;
    }

    function renderSol(){
      const sol = (DATA?.agents?.sol || []);
      qs('#solCount').textContent = sol.length;
      qs('#solLast').textContent = sol.length ? (sol[sol.length-1].timestamp || '--') : '--';
      const inner = qs('#solFeedInner');
      if(!sol.length){ qs('#solEmpty').style.display='block'; inner.innerHTML=''; return; }
      qs('#solEmpty').style.display='none';
      const rows = sol.slice(-30).reverse().map(evtRow).join('');
      inner.innerHTML = rows;
    }

    function renderSimpleList(containerId, list, mapFn){
      const el = qs('#'+containerId);
      if(!list || !list.length){ el.innerHTML = `<div class="meta">No items yet.</div>`; return; }
      el.innerHTML = list.slice(-60).reverse().map(mapFn).join('');
    }

    function renderThoughts(){
      renderSimpleList('thoughtList', DATA?.thoughts || [], (t)=>{
        const title = (t.type || 'thought');
        const summary = (t.content || '');
        const detail = (t.detail_text || t.content || '');
        return `<div class="evt" data-title="${safe(title)}" data-detail="${safe(detail)}"><div class="ts">${safe((t.timestamp||'').slice(-5))}</div><div class="tag thinking">thought</div><div class="summary">${safe(summary)}</div></div>`;
      });
    }

    function renderMemories(){
      renderSimpleList('memoryList', DATA?.memories || [], (m)=>{
        const title = m.title || 'Memory';
        const summary = m.preview || m.content || '';
        const detail = m.content || m.preview || '';
        return `<div class="evt" data-title="${safe(title)}" data-detail="${safe(detail)}"><div class="ts">${safe(m.date||'')}</div><div class="tag memory">memory</div><div class="summary"><b>${safe(title)}</b><div class="subline">${safe(summary)}</div></div></div>`;
      });
    }

    function renderImprovements(){
      renderSimpleList('improveList', DATA?.improvements || [], (i)=>{
        const title = i.title || 'Improvement';
        const summary = i.content || '';
        const detail = i.detail_text || i.content || '';
        return `<div class="evt" data-title="${safe(title)}" data-detail="${safe(detail)}"><div class="ts">${safe((i.timestamp||'').slice(-5))}</div><div class="tag improvement">improve</div><div class="summary"><b>${safe(title)}</b><div class="subline">${safe(summary)}</div></div></div>`;
      });
    }

    function initHistoryControls(){
      const agentSel = qs('#hAgent');
      agentSel.innerHTML = `<option value="">All agents</option>` +
        [`<option value="sol">sol</option>`].concat(AGENTS.map(a=>`<option value="${a.key}">${a.key}</option>`)).join('');

      const typeSel = qs('#hType');
      typeSel.innerHTML = `<option value="">All types</option>`;

      agentSel.addEventListener('change', renderHistory);
      typeSel.addEventListener('change', renderHistory);
      qs('#hSearch').addEventListener('input', renderHistory);
      qs('#hLimit').addEventListener('change', renderHistory);
    }

    function renderHistory(){
      const body = qs('#hBody');
      const events = Array.isArray(DATA?.events) ? DATA.events : [];
      if(!events.length){ body.innerHTML = `<tr><td colspan="4" style="padding:14px;color:var(--muted);">No DB events yet.</td></tr>`; return; }

      // Populate type dropdown from DB
      const types = Array.from(new Set(events.map(e=>e.type))).sort();
      const typeSel = qs('#hType');
      const cur = typeSel.value;
      typeSel.innerHTML = `<option value="">All types</option>` + types.map(t=>`<option value="${safe(t)}">${safe(t)}</option>`).join('');
      typeSel.value = cur;

      const agent = qs('#hAgent').value;
      const typ = qs('#hType').value;
      const q = (qs('#hSearch').value || '').trim().toLowerCase();
      const limit = parseInt(qs('#hLimit').value,10) || 100;

      let rows = events.slice();
      if(agent) rows = rows.filter(e=>e.agent===agent);
      if(typ) rows = rows.filter(e=>e.type===typ);
      if(q) rows = rows.filter(e=>(e.summary||'').toLowerCase().includes(q) || (e.detail_text||'').toLowerCase().includes(q));
      rows = rows.slice(0, limit);

      body.innerHTML = rows.map(e=>{
        const dt = (e.detail_text || (e.payload && e.payload.detail_text) || '').toString();
        const title = `${e.agent} ‚Ä¢ ${e.type}`;
        return `
          <tr class="hRow" data-title="${safe(title)}" data-detail="${safe(dt || e.summary)}" style="cursor:pointer;">
            <td style="padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);color:var(--muted);font-family:var(--mono);font-size:.72rem;">${safe((e.ts||'').replace('T',' ').slice(0,19))}</td>
            <td style="padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);">${safe(e.agent)}</td>
            <td style="padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);color:var(--muted);">${safe(e.type)}</td>
            <td style="padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);">${safe(e.summary)}</td>
          </tr>
        `;
      }).join('');

      qsa('.hRow').forEach(r=>{
        r.addEventListener('click', ()=> openModal(r.dataset.title, r.dataset.detail));
      });
    }

    async function fetchSys(){
      try{
        const r = await fetch('/sys.json?_='+Date.now(), { cache: 'no-store' });
        const sys = await r.json();
        LAST_SYS = sys;
        const l = sys.loadavg || {};
        qs('#sysLoad').textContent = `${l['1m']} / ${l['5m']} / ${l['15m']}`;

        if(sys.meminfo && sys.meminfo.MemAvailable){
          const kb = parseFloat(sys.meminfo.MemAvailable.split(' ')[0]);
          const mb = kb/1024;
          qs('#sysMemAvail').textContent = `${mb.toFixed(0)} MB`;
          SYS_HIST.memAvailMb.push(mb);
        }

        if(sys.disk_root){
          qs('#sysDiskFree').textContent = fmtBytes(sys.disk_root.free_bytes);
          SYS_HIST.diskFreeGb.push(sys.disk_root.free_bytes/1024/1024/1024);
        }

        SYS_HIST.load1.push(Number(l['1m'])||0);

        for(const k of ['load1','memAvailMb','diskFreeGb']){
          if(SYS_HIST[k].length>SYS_HIST.max) SYS_HIST[k]=SYS_HIST[k].slice(-SYS_HIST.max);
        }

        // System tab graphs
        drawSpark('chartLoad', SYS_HIST.load1.slice(-60), '#58a6ff');
        drawSpark('chartMem', SYS_HIST.memAvailMb.slice(-60), '#3fb950');
        drawSpark('chartDisk', SYS_HIST.diskFreeGb.slice(-60), '#d29922');

        // Overview graphs (same history)
        drawSpark('chartLoadOv', SYS_HIST.load1.slice(-60), '#58a6ff');
        drawSpark('chartMemOv', SYS_HIST.memAvailMb.slice(-60), '#3fb950');
        drawSpark('chartDiskOv', SYS_HIST.diskFreeGb.slice(-60), '#d29922');

        // Overview numbers
        qs('#ovLoad').textContent = `${l['1m']}`;
        if(sys.meminfo && sys.meminfo.MemAvailable){
          const kb2 = parseFloat(sys.meminfo.MemAvailable.split(' ')[0]);
          const mb2 = kb2/1024;
          qs('#ovMem').textContent = `${mb2.toFixed(0)} MB`;
        }
        if(sys.disk_root){
          qs('#ovDisk').textContent = fmtBytes(sys.disk_root.free_bytes);
        }

        // Overview card titles
        qs('#sysLoadOv').textContent = `${l['1m']}`;
        if(sys.meminfo && sys.meminfo.MemAvailable){
          const kb3 = parseFloat(sys.meminfo.MemAvailable.split(' ')[0]);
          const mb3 = kb3/1024;
          qs('#sysMemAvailOv').textContent = `${mb3.toFixed(0)} MB`;
        }
        if(sys.disk_root){
          qs('#sysDiskFreeOv').textContent = fmtBytes(sys.disk_root.free_bytes);
        }

        document.querySelectorAll('[data-drill="sys"]').forEach(el=>{
          if(el.__bound) return;
          el.__bound=true;
          el.addEventListener('click', ()=> openModal('System details', JSON.stringify(LAST_SYS, null, 2)));
        });
      }catch{}
    }

    async function fetchData(){
      let payload;
      try{
        const r = await fetch('/data.json?_='+Date.now(), { cache: 'no-store' });
        payload = await r.json();
      }catch(e){
        qs('#jsStatus').textContent = 'JS: fetch failed (' + (e?.message||e) + ')';
        return;
      }

      DATA = payload;
      qs('#fetchTs').textContent = new Date().toLocaleTimeString();

      try{
        const t = DATA?.rate_limits?.tavily;
        const l = DATA?.rate_limits?.llm;
        qs('#mTavily').textContent = (t?.remaining ?? '-') + '/5';
        qs('#mLlm').textContent = (l?.remaining ?? '-') + '/20';
        qs('#mEvents').textContent = Array.isArray(DATA?.events) ? DATA.events.length : '--';

        renderSol();
        renderTiles();
        renderThoughts();
        renderMemories();
        renderImprovements();
        if(qs('#panel-history').classList.contains('active')) renderHistory();

        // bind modal click for event cards
        qsa('.evt').forEach(el=>{
          if(el.__bound) return;
          el.__bound = true;
          el.addEventListener('click', ()=> openModal(el.dataset.title || 'Details', (el.dataset.detail || '').replace(/\\n/g,'\n')));
        });

        qs('#jsStatus').textContent = 'JS: ok';
      }catch(e){
        qs('#jsStatus').textContent = 'JS: render failed (' + (e?.message||e) + ')';
      }
    }

    setTabs();
    initHistoryControls();
    fetchData();
    fetchSys();
    setInterval(()=>fetchData().catch(()=>{}), 2000);
    setInterval(()=>fetchSys().catch(()=>{}), 2000);
  </script>
</body>
</html>
